<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Loan Application</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .button { 
            background: #3b82f6; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        .button:hover { background: #2563eb; }
        .output { 
            background: #f3f4f6; 
            padding: 15px; 
            border-radius: 5px; 
            margin: 10px 0; 
            white-space: pre-wrap;
        }
        .success { background: #d1fae5; border-left: 4px solid #10b981; }
        .error { background: #fee2e2; border-left: 4px solid #ef4444; }
        .info { background: #dbeafe; border-left: 4px solid #3b82f6; }
    </style>
</head>
<body>
    <h1>üîß Test Loan Application Fix</h1>
    
    <div>
        <button class="button" onclick="createTestBorrower()">Create Test Borrower User</button>
        <button class="button" onclick="testLoanApplication()">Test Loan Application API</button>
        <button class="button" onclick="testCollateralSubmission()">Test Collateral Submission API</button>
        <button class="button" onclick="checkAuthState()">Check Auth State</button>
        <button class="button" onclick="clearAllData()">Clear All Data</button>
    </div>

    <div id="output" class="output">Ready to test loan application fixes...</div>

    <script>
        function createTestBorrower() {
            const testUser = {
                id: 'test-borrower-' + Date.now(),
                firstName: 'Test',
                lastName: 'Borrower',
                email: 'borrower@test.com',
                userType: 'borrower',
                kycStatus: 'approved',
                isEmailVerified: true,
                creditScore: 600,
                phone: '+1987654321',
                createdAt: new Date().toISOString()
            };

            const testToken = 'test-access-token-borrower-' + Date.now();
            const testRefreshToken = 'test-refresh-token-borrower-' + Date.now();

            localStorage.setItem('accessToken', testToken);
            localStorage.setItem('refreshToken', testRefreshToken);
            localStorage.setItem('user', JSON.stringify(testUser));

            showOutput('‚úÖ Test borrower user created successfully!', 'success');
            showOutput(`User: ${testUser.firstName} ${testUser.lastName} (${testUser.userType})`, 'success');
            showOutput(`Email: ${testUser.email}`, 'success');
        }

        async function testLoanApplication() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                showOutput('‚ùå No authentication token found. Please create a test user first.', 'error');
                return;
            }

            const loanData = {
                loanAmount: 5000,
                purpose: 'Business expansion',
                duration: 12,
                repaymentSchedule: 'monthly',
                description: 'Need funds for business expansion and equipment purchase',
                collateral: 'Business equipment and inventory'
            };

            try {
                showOutput('üöÄ Testing loan application submission...', 'info');
                showOutput(`Data: ${JSON.stringify(loanData, null, 2)}`, 'info');

                const response = await fetch('http://localhost:5000/api/borrower/loan/apply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(loanData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showOutput('‚úÖ Loan application submitted successfully!', 'success');
                    showOutput(`Response: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showOutput('‚ùå Loan application failed!', 'error');
                    showOutput(`Error: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                showOutput('‚ùå Network error:', 'error');
                showOutput(`Error: ${error.message}`, 'error');
            }
        }

        async function testCollateralSubmission() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                showOutput('‚ùå No authentication token found. Please create a test user first.', 'error');
                return;
            }

            // Create a simple test document (base64 encoded "test document")
            const testDocument = {
                name: 'test-document.pdf',
                base64: 'data:application/pdf;base64,JVBERi0xLjQKJcfsj6IKNSAwIG9iago8PAovVHlwZSAvUGFnZQovUGFyZW50IDMgMCBSCi9SZXNvdXJjZXMgPDwKL0ZvbnQgPDwKL0YxIDIgMCBSCj4+Cj4+Ci9NZWRpYUJveCBbMCAwIDYxMiA3OTJdCi9Db250ZW50cyA0IDAgUgo+Pgo1IDAgb2JqCjw8Ci9UeXBlIC9QYWdlCi9QYXJlbnQgMyAwIFIKL1Jlc291cmNlcyA8PAovRm9udCA8PAovRjEgMiAwIFIKPj4KPj4KL01lZGlhQm94IFswIDAgNjEyIDc5Ml0KL0NvbnRlbnRzIDQgMCBSCj4+CjQgMCBvYmoKPDwKL0xlbmd0aCA0NAo+PgpzdHJlYW0KQlQKL0YxIDEyIFRmCjcyIDcyMCBUZAooVGVzdCBEb2N1bWVudCkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iago2IDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovQmFzZUZvbnQgL0hlbHZldGljYQo+PgplbmRvYmoKMiAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKPj4KZW5kb2JqCjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFs1IDAgUl0KL0NvdW50IDEKPj4KZW5kb2JqCjcgMCBvYmoKPDwKL1R5cGUgL0NhdGFsb2cKL1BhZ2VzIDMgMCBSCj4+CmVuZG9iagp4cmVmCjAgOAowMDAwMDAwMDAwIDY1NTM1IGYKMDAwMDAwMDAwOSAwMDAwMCBuCjAwMDAwMDAwNTggMDAwMDAgbgowMDAwMDAwMTE1IDAwMDAwIG4KMDAwMDAwMDE2MCAwMDAwMCBuCjAwMDAwMDAyNDcgMDAwMDAgbgowMDAwMDAwMzI0IDAwMDAwIG4KMDAwMDAwMDQwMSAwMDAwMCBuCnRyYWlsZXIKPDwKL1NpemUgOAovUm9vdCA3IDAgUgo+PgpzdGFydHhyZWYKNDk1CiUlRU9G',
                size: 1000,
                type: 'application/pdf'
            };

            const collateralData = {
                collateralType: 'business',
                description: 'Business equipment and inventory',
                estimatedValue: 10000,
                bvn: '12345678901',
                documentTypes: ['other'],
                collateralDocuments: [testDocument],
                bankStatement: {
                    name: 'bank-statement.pdf',
                    base64: 'data:application/pdf;base64,JVBERi0xLjQKJcfsj6IKNSAwIG9iago8PAovVHlwZSAvUGFnZQovUGFyZW50IDMgMCBSCi9SZXNvdXJjZXMgPDwKL0ZvbnQgPDwKL0YxIDIgMCBSCj4+Cj4+Ci9NZWRpYUJveCBbMCAwIDYxMiA3OTJdCi9Db250ZW50cyA0IDAgUgo+Pgo1IDAgb2JqCjw8Ci9UeXBlIC9QYWdlCi9QYXJlbnQgMyAwIFIKL1Jlc291cmNlcyA8PAovRm9udCA8PAovRjEgMiAwIFIKPj4KPj4KL01lZGlhQm94IFswIDAgNjEyIDc5Ml0KL0NvbnRlbnRzIDQgMCBSCj4+CjQgMCBvYmoKPDwKL0xlbmd0aCA0NAo+PgpzdHJlYW0KQlQKL0YxIDEyIFRmCjcyIDcyMCBUZAooVGVzdCBEb2N1bWVudCkgVGoKRVQKZW5kc3RyZWFtCmVuZG9iago2IDAgb2JqCjw8Ci9UeXBlIC9Gb250Ci9TdWJ0eXBlIC9UeXBlMQovQmFzZUZvbnQgL0hlbHZldGljYQo+PgplbmRvYmoKMiAwIG9iago8PAovVHlwZSAvRm9udAovU3VidHlwZSAvVHlwZTEKL0Jhc2VGb250IC9IZWx2ZXRpY2EKPj4KZW5kb2JqCjMgMCBvYmoKPDwKL1R5cGUgL1BhZ2VzCi9LaWRzIFs1IDAgUl0KL0NvdW50IDEKPj4KZW5kb2JqCjcgMCBvYmoKPDwKL1R5cGUgL0NhdGFsb2cKL1BhZ2VzIDMgMCBSCj4+CmVuZG9iagp4cmVmCjAgOAowMDAwMDAwMDAwIDY1NTM1IGYKMDAwMDAwMDAwOSAwMDAwMCBuCjAwMDAwMDAwNTggMDAwMDAgbgowMDAwMDAwMTE1IDAwMDAwIG4KMDAwMDAwMDE2MCAwMDAwMCBuCjAwMDAwMDAyNDcgMDAwMDAgbgowMDAwMDAwMzI0IDAwMDAwIG4KMDAwMDAwMDQwMSAwMDAwMCBuCnRyYWlsZXIKPDwKL1NpemUgOAovUm9vdCA3IDAgUgo+PgpzdGFydHhyZWYKNDk1CiUlRU9G',
                size: 1000,
                type: 'application/pdf'
            };

            try {
                showOutput('üöÄ Testing collateral submission...', 'info');
                showOutput(`Data: ${JSON.stringify(collateralData, null, 2)}`, 'info');

                const response = await fetch('http://localhost:5000/api/collateral/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(collateralData)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showOutput('‚úÖ Collateral submission successful!', 'success');
                    showOutput(`Response: ${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showOutput('‚ùå Collateral submission failed!', 'error');
                    showOutput(`Error: ${JSON.stringify(result, null, 2)}`, 'error');
                }
            } catch (error) {
                showOutput('‚ùå Network error:', 'error');
                showOutput(`Error: ${error.message}`, 'error');
            }
        }

        function checkAuthState() {
            const token = localStorage.getItem('accessToken');
            const user = localStorage.getItem('user');

            let output = 'üîç Current Authentication State:\n\n';
            output += `Access Token: ${token ? '‚úÖ Present' : '‚ùå Missing'}\n`;
            output += `User Data: ${user ? '‚úÖ Present' : '‚ùå Missing'}\n\n`;

            if (user) {
                try {
                    const userData = JSON.parse(user);
                    output += `User Details:\n`;
                    output += `- Name: ${userData.firstName} ${userData.lastName}\n`;
                    output += `- Email: ${userData.email}\n`;
                    output += `- User Type: ${userData.userType}\n`;
                } catch (e) {
                    output += `‚ùå Error parsing user data: ${e.message}\n`;
                }
            }

            showOutput(output, user ? 'success' : 'error');
        }

        function clearAllData() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            showOutput('üóëÔ∏è All authentication data cleared.', 'success');
        }

        function showOutput(message, type = '') {
            const output = document.getElementById('output');
            output.textContent = message;
            output.className = `output ${type}`;
        }

        // Check initial state
        checkAuthState();
    </script>
</body>
</html>

